buildscript {
    repositories {
        maven { url '../../../../../out/repo' }
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:0.13.1'
    }
}

task manifestMerger(type: com.android.build.gradle.tasks.InvokeManifestMerger) {
    mainManifestFile = file('AndroidManifest.xml')
    secondaryManifestFiles = [ file('Lib1_AndroidManifest.xml'), file('Lib2_AndroidManifest.xml') ]
    outputFile = file('build/Result_AndroidManifest.xml')
}

task assembleDebug << {
    String actual = new File('build/Result_AndroidManifest.xml').text
    if (actual.indexOf("foo.permission.SEND_SMS") == -1 || actual.indexOf("foo.permission-group.COST_MONEY") == -1) {
        throw new org.gradle.tooling.BuildException("Resulting file is different from expected", null)
    }
}

assembleDebug.dependsOn manifestMerger